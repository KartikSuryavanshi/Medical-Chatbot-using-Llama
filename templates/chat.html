<!DOCTYPE html>
<html lang="en">
	<head>
		<meta charset="UTF-8" />
		<meta name="viewport" content="width=device-width, initial-scale=1.0" />
		<title>Medical Chatbot</title>
		<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" />
		<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css" />
		<link rel="stylesheet" href="{{ url_for('static', filename='style.css')}}" />
	</head>

	<body>
		<div class="app-shell">
			<header class="app-header">
				<div class="avatar">
					<img src="https://www.prdistribution.com/spirit/uploads/pressreleases/2019/newsreleases/d83341deb75c4c4f6b113f27b1e42cd8-chatbot-florence-already-helps-thousands-of-patients-to-remember-their-medication.png" alt="Bot" />
					<span class="status-dot" aria-label="online"></span>
				</div>
				<div>
					<p class="eyebrow">Medical Companion</p>
					<h1 class="title">Ask me anything</h1>
				</div>
			</header>

			<main class="chat-card">
				<div id="messages" class="messages" aria-live="polite"></div>

				<form id="messageForm" class="composer" autocomplete="off">
					<input
						type="text"
						id="text"
						name="msg"
						class="composer-input"
						placeholder="Type your message..."
						required
					/>
					<button type="submit" id="send" class="composer-send" aria-label="Send message">
						<i class="fas fa-paper-plane"></i>
					</button>
				</form>
			</main>
		</div>

		<script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.7.1/jquery.min.js"></script>
		<script>
			$(function () {
				const messagesEl = $("#messages");

				function timeStamp() {
					const d = new Date();
					return d.toLocaleTimeString([], { hour: "2-digit", minute: "2-digit" });
				}

				function appendUser(text) {
					const html = `
						<div class="bubble-row bubble-row--user">
							<div class="bubble bubble--user">
								<p>${$('<div/>').text(text).html()}</p>
								<span class="meta">${timeStamp()}</span>
							</div>
						</div>`;
					messagesEl.append(html);
					messagesEl.scrollTop(messagesEl[0].scrollHeight);
				}

				function appendBot(text) {
					const html = `
						<div class="bubble-row bubble-row--bot">
							<div class="avatar tiny">
								<img src="https://www.prdistribution.com/spirit/uploads/pressreleases/2019/newsreleases/d83341deb75c4c4f6b113f27b1e42cd8-chatbot-florence-already-helps-thousands-of-patients-to-remember-their-medication.png" alt="Bot" />
							</div>
							<div class="bubble bubble--bot">
								<p>${$('<div/>').text(text).html()}</p>
								<span class="meta">${timeStamp()}</span>
							</div>
						</div>`;
					messagesEl.append(html);
					messagesEl.scrollTop(messagesEl[0].scrollHeight);
				}

				function appendTyping() {
					const html = `
						<div class="bubble-row bubble-row--bot" id="typing-row">
							<div class="avatar tiny">
								<img src="https://www.prdistribution.com/spirit/uploads/pressreleases/2019/newsreleases/d83341deb75c4c4f6b113f27b1e42cd8-chatbot-florence-already-helps-thousands-of-patients-to-remember-their-medication.png" alt="Bot" />
							</div>
							<div class="bubble bubble--bot typing">
								<span class="dot"></span><span class="dot"></span><span class="dot"></span>
							</div>
						</div>`;
					messagesEl.append(html);
					messagesEl.scrollTop(messagesEl[0].scrollHeight);
				}

				function removeTyping() {
					$("#typing-row").remove();
				}

				$("#messageForm").on("submit", function (e) {
					e.preventDefault();
					const text = $("#text").val().trim();
					if (!text) return;

					appendUser(text);
					$("#text").val("");
					appendTyping();

					$.ajax({
						type: "POST",
						url: "/get",
						data: { msg: text },
					})
						.done(function (data) {
							removeTyping();
							appendBot(data);
						})
						.fail(function () {
							removeTyping();
							appendBot("Sorry, I couldnâ€™t reach the server. Please try again.");
						});
				});
			});
		</script>
	</body>
</html>